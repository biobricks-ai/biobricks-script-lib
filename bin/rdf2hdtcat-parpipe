#!/bin/bash

set -euo pipefail;

export LC_ALL=C

RDF2HDTCAT_PARALLEL_OPTS_DEFAULT='-j4 --block-size 500M'
RDF2HDTCAT_RDF2HDT_OPTS_DEFAULT='-p'

if [ "$#" -ne 2 ] || [ -z "$1" ] || [ -z "$2" ]; then
	cat <<EOF >&2
# NAME

  rdf2hdtcat-parpipe - parallel processing of RDF N-Triples to HDT

# SYNOPSIS

  rdf2hdtcat-parpipe base-uri output.hdt < rdf.nt

# DESCRIPTION

Takes RDF N-Triples input on STDIN and outputs an RDF HDT file generated by
splitting the input into partitions and then merging them.

# ENVIRONMENT

  * TMPDIR:

    Used for temporary files. See mktemp(1).

  * RDF2HDTCAT_PARALLEL_OPTS:

    Passed to parallel(1).

    Default: '$RDF2HDTCAT_PARALLEL_OPTS_DEFAULT'

  * RDF2HDTCAT_RDF2HDT_OPTS:

    Passed to rdf2hdt.

    Default: '$RDF2HDTCAT_RDF2HDT_OPTS_DEFAULT'

EOF
	exit 1
fi

RDF_HDT_BASE_URI="$1"
RDF_HDT_FINAL="$2"

export RDF2HDTCAT_PARALLEL_OPTS=${RDF2HDTCAT_PARALLEL_OPTS:-$RDF2HDTCAT_PARALLEL_OPTS_DEFAULT}
export RDF2HDTCAT_RDF2HDT_OPTS=${RDF2HDTCAT_RDF2HDT_OPTS:-$RDF2HDTCAT_RDF2HDT_OPTS_DEFAULT}

## Partition the data on `STDIN` into blocks that each get processed with
## `rdf2hdt`.
##
## NOTE: using `parallel` with `--cat` for temporary file (as opposed to
## `--fifo`) because `rdf2hdt` from `hdt-cpp` does not work on `STDIN` directly
## (due to not having one-pass processing).
## See <https://github.com/rdfhdt/hdt-cpp/issues/233#issuecomment-1054008231>.
PART_LIST=$(mktemp --suffix=.rdf2hdtcat-part.lst)
export RDF_HDT_BASE_URI
parallel $RDF2HDTCAT_PARALLEL_OPTS --pipe --cat --keep-order '
	PART_TEMP=$(mktemp -d) \
		&& rdf2hdt $RDF2HDTCAT_RDF2HDT_OPTS -B $RDF_HDT_BASE_URI -f ntriples {} $PART_TEMP/part_{#}.hdt \
		&& echo $PART_TEMP/part_{#}.hdt' > $PART_LIST;

if [ -s $PART_LIST ]; then
	## Use hdtcat-file-list to merge the HDT files
	hdtcat-file-list $PART_LIST $RDF_HDT_FINAL
	## Remove temporary files and directories inside of $PART_LIST.
	< $PART_LIST parallel 'rm {} && rmdir {//}'
	rm $PART_LIST ## Remove temporary file.
else
	echo "$0: Empty partitions of RDF input: possibly missing N-Triples input on STDIN?" >&2
	rm $PART_LIST ## Remove temporary file.
	exit 1
fi
